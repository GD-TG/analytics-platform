# üìä Analytics Platform ‚Äî DEMO Scenario

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏

### –ü—Ä–µ–¥—É—Å–ª–æ–≤–∏—è
- PHP 8.1+, MySQL 8.0+, Node.js 16+
- –ö–æ–º–ø–æ–∑–µ—Ä –∏ npm —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- Yandex OAuth credentials (.env —Å `YANDEX_CLIENT_ID`, `YANDEX_CLIENT_SECRET`)

---

## –®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î –∏ seed –¥–∞–Ω–Ω—ã—Ö

```bash
# 1. –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å APP_KEY (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
php artisan key:generate

# 2. –°–æ–∑–¥–∞—Ç—å –ë–î
mysql -u root -p -e "CREATE DATABASE analytics_platform CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 3. –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
php artisan migrate

# 4. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
php artisan db:seed

# ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: 2 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, 2 –ø—Ä–æ–µ–∫—Ç–∞, 2 —Å—á—ë—Ç—á–∏–∫–∞, 6 –º–µ—Å—è—Ü–µ–≤ –º–µ—Ç—Ä–∏–∫
```

### –¢–µ—Å—Ç–æ–≤—ã–µ —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

| Email | –ü–∞—Ä–æ–ª—å | –ü—Ä–æ–µ–∫—Ç |
|-------|--------|--------|
| test1@example.com | password123 | Ecommerce Site |
| test2@example.com | password123 | SaaS Dashboard |

---

## –®–∞–≥ 2: –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤

### Terminal 1 ‚Äî Backend (Laravel)
```bash
php artisan serve --host=127.0.0.1 --port=8000
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
Laravel development server started: http://127.0.0.1:8000
```

### Terminal 2 ‚Äî Frontend (React + Vite)
```bash
cd frontend
npm install  # –µ—Å–ª–∏ –ø–µ—Ä–≤—ã–π —Ä–∞–∑
npm run dev
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
  Local:        http://localhost:5173/
  Press q to quit
```

### Terminal 3 ‚Äî Queue Worker (–æ–±—Ä–∞–±–æ—Ç–∫–∞ background jobs)
```bash
php artisan queue:work --queue=metrika-fetch,default
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
Processing jobs from the [metrika-fetch, default] queues
```

---

## –®–∞–≥ 3: –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π

### –°—Ü–µ–Ω–∞—Ä–∏–π A: –í—Ö–æ–¥ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ OAuth)

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä** ‚Üí http://localhost:5173
2. **–ù–∞–∂–º–∏—Ç–µ "Login"** (–≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –∏–ª–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ)
3. **–í–≤–µ–¥–∏—Ç–µ —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
   - Email: `test1@example.com`
   - Password: `password123`
4. **–ù–∞–∂–º–∏—Ç–µ "Sign In"**
5. **‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** Dashboard —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –¥–ª—è "Ecommerce Site"
   - –í–∏–¥–Ω–æ 3 –º–µ—Å—è—Ü–∞ –¥–∞–Ω–Ω—ã—Ö (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞)
   - –ì—Ä–∞—Ñ–∏–∫–∏: Visits, Sources, Age Groups, Goals
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –≤—Å–µ–≥–æ –≤–∏–∑–∏—Ç—ã, —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, bounce rate

---

### –°—Ü–µ–Ω–∞—Ä–∏–π B: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Yandex.Metrika (Per-user OAuth)

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–π Yandex –∞–∫–∫–∞—É–Ω—Ç –∏ Yandex Metrika —Å—á—ë—Ç—á–∏–∫

1. **–ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞** ‚Üí –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É Settings –∏–ª–∏ –Ω–∞–π—Ç–∏ –∫–Ω–æ–ø–∫—É "Connect Yandex"
2. **–ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å Yandex"** ‚Üí –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ oauth.yandex.ru
3. **–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å** —Å –≤–∞—à–∏–º Yandex –∞–∫–∫–∞—É–Ω—Ç–æ–º
4. **–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø** (approve permission dialog)
5. **–í–µ—Ä–Ω—ë—Ç–µ—Å—å –Ω–∞ http://localhost:5173/yandex/select**
6. **–£–≤–∏–¥–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö —Å—á—ë—Ç—á–∏–∫–æ–≤** (–∏–∑ –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ Yandex)
7. **–í—ã–±–µ—Ä–∏—Ç–µ —Å—á—ë—Ç—á–∏–∫–∏** (checkbox'–∏)
8. **–ù–∞–∂–º–∏—Ç–µ "Save"** 
9. **‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –¢–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î (encrypted –≤ —Ç–∞–±–ª–∏—Ü–µ yandex_accounts)
   - –°—á—ë—Ç—á–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É yandex_counters
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö

---

### –°—Ü–µ–Ω–∞—Ä–∏–π C: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (Background Jobs)

> **–¢—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Yandex API**

1. **–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—á—ë—Ç—á–∏–∫–æ–≤** ‚Üí Queue worker –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç `FetchMetrikaJob`
2. **–í Terminal 3** –≤—ã —É–≤–∏–¥–∏—Ç–µ –≤—ã–≤–æ–¥:
   ```
   Processing: FetchMetrikaJob {counter_id}
   ```
3. **–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è** –≤ —Ç–∞–±–ª–∏—Ü—ã:
   - `raw_api_responses` (—Å—ã—Ä—ã–µ JSON –æ—Ç–≤–µ—Ç—ã)
   - `metrics_monthly` (–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Å—è—á–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏)
   - `metrics_age_monthly` (–¥–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ)
4. **‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - Dashboard –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ Yandex
   - –í–∏–¥–Ω—ã –≤–∏–∑–∏—Ç—ã, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –º–µ—Å—è—Ü—ã

---

## –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –¢–µ—Å—Ç: Route Protection (auth:sanctum)

```bash
# –ü–æ–ø—ã—Ç–∫–∞ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ (–¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å 401)
curl -X POST http://localhost:8000/api/yandex/exchange-code-new \
  -H "Content-Type: application/json" \
  -d '{"code":"test"}'

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
# {"message":"Unauthorized"}

# –° —Ç–æ–∫–µ–Ω–æ–º Sanctum (–ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞):
# –ü–æ–ª—É—á–∏—Ç–µ 200 —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –æ—Ç–≤–µ—Ç–æ–º
```

### –¢–µ—Å—Ç: Per-user –∏–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

1. **–õ–æ–≥–∏–Ω–∏—Ç–µ—Å—å** –∫–∞–∫ `test1@example.com`
2. **–ü–æ–ø—ã—Ç–∞–π—Ç–µ—Å—å –ø–æ–ª—É—á–∏—Ç—å** —Å—á—ë—Ç—á–∏–∫–∏ `test2`:
   ```bash
   curl -X GET "http://localhost:8000/api/yandex/counters?account_id=2" \
     -H "Authorization: Bearer {test1_token}"
   ```
3. **‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** 404 "account not found or unauthorized"

---

## –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ MySQL
mysql -u root -p analytics_platform

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã
SHOW TABLES;

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT id, name, email FROM users;

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Yandex –∞–∫–∫–∞—É–Ω—Ç—ã (—Ç–æ–∫–µ–Ω—ã encrypted)
SELECT id, user_id, provider_user_id, encrypted_access_token, expires_at FROM yandex_accounts;

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏
SELECT id, counter_id, project_id, name FROM yandex_counters;

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏
SELECT project_id, year, month, visits, users, conversions FROM metrics_monthly ORDER BY year DESC, month DESC;
```

---

## Troubleshooting

### "–ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π
php artisan migrate:status

# –û—Ç–∫–∞—Ç–∏—Ç—å –∏ –ø–µ—Ä–µ–ø—Ä–∏–º–µ–Ω–∏—Ç—å
php artisan migrate:rollback
php artisan migrate
php artisan db:seed
```

### "Queue worker –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è"
```bash
# –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ Redis —Ä–∞–±–æ—Ç–∞–µ—Ç (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
redis-cli ping
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å PONG

# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è database queue driver ‚Äî –≤—Å—ë –æ–∫
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ .env: QUEUE_CONNECTION=database –∏–ª–∏ redis
```

### "Frontend –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è"
```bash
# –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
cd frontend
npm install

# –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à Vite
rm -rf node_modules/.vite

# –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
npm install
npm run dev
```

### "Yandex OAuth –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `.env`: `YANDEX_CLIENT_ID` –∏ `YANDEX_CLIENT_SECRET` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å redirect URI —Å–æ–≤–ø–∞–¥–∞–µ—Ç –≤ config –∏ –≤ Yandex.OAuth settings
- –í –±—Ä–∞—É–∑–µ—Ä–µ –æ—Ç–∫—Ä—ã—Ç—å DevTools (F12) –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å Network ‚Äî –µ—Å—Ç—å –ª–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ oauth.yandex.ru

---

## –û–∂–∏–¥–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ demo

| –ü—É–Ω–∫—Ç | –°—Ç–∞—Ç—É—Å |
|-------|--------|
| Login —Ä–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ |
| Dashboard –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ | ‚úÖ |
| Yandex OAuth flow (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω) | ‚úÖ |
| –¢–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ encrypted | ‚úÖ |
| Queue worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç jobs | ‚úÖ |
| Per-user –∏–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö | ‚úÖ |
| Route protection (auth:sanctum) | ‚úÖ |

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è demo

```bash
# –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ª–æ–≥–∏
php artisan logs:clear

# –°–±—Ä–æ—Å–∏—Ç—å –ë–î –∏ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
php artisan migrate:fresh --seed

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ—á–µ—Ä–µ–¥–∏
php artisan queue:failed

# –ü–µ—Ä–µ–ø–æ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–µ—É–¥–∞—á–Ω—ã–µ jobs
php artisan queue:retry all

# –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ Laravel
tail -f storage/logs/laravel.log

# –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –æ—á–µ—Ä–µ–¥–∏
tail -f storage/logs/queue.log
```

---

**üéØ –î–µ–º–æ –≥–æ—Ç–æ–≤–æ –∫ –ø–æ–∫–∞–∑—É!**

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî check Troubleshooting section –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ.
